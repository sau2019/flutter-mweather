(window.webpackJsonp=window.webpackJsonp||[]).push([["spark-core-wraper"],{1121:function(e,t,r){"use strict";var o=r(46),n=r(61),i=r(1292),a=r(1473),s=(r(1331),"root"),l=function(){function e(t,r){o(this,e),this._controller=r;var n=t||{};n.discoverySpec?this.id=n.discoverySpec.getFolderId():this.id=n.id,this.isFolder=!0,this.parentFolder=n.parentFolder||null,this.name=n.name,this.id!==s||this.name||(this.name="Projects"),n.discoverySpec||(n.discoverySpec=new i.a(null,null,null,null,this.id)),this._discoveryContext=new a.a(n.discoverySpec,r),this._discoveryContext.getSpec().folder=this,void 0!==n.folderCount&&(this._discoveryContext.totalFolders=n.folderCount),void 0!==n.projectCount&&(this._discoveryContext.totalProjects=n.projectCount)}return n(e,[{key:"refreshInfo",value:function(e){return e.name!==this.name&&(this.name=e.name,!0)}},{key:"setName",value:function(e){this.name=e}},{key:"setSpec",value:function(e){this._discoveryContext.setSpec(e)}},{key:"getSpec",value:function(){return this._discoveryContext.getSpec()}},{key:"delete",value:function(){return this._controller.deleteSubfolder(this.parentFolder,this.id)}},{key:"rename",value:function(e){return this._controller.renameFolder(this,e)}},{key:"getDiscoveryContext",value:function(){return this._discoveryContext}},{key:"move",value:function(e){return this._controller.move([this],e)}},{key:"getDisplayName",value:function(){return this.name}}]),e}();l.COMPONENT_NAME="spark-folder",t.a=l},1292:function(e,t,r){"use strict";var o=r(46),n=r(61),i="root",a=function(){function e(t){o(this,e);var r=t||{};this._filter=r.filter,this._incomingCollabOnly=r.incomingCollabOnly,this._sort=r.sort,this._sortDirection=r.sortDirection,this._folderId=r.folderId||i,this._useFlatApi=r.useFlatApi||!1}return n(e,[{key:"getKey",value:function(){return this.getFolderId()+this.getFilter()+this.getIncomingCollabOnly()+this.getSort()+this.getSortDirection()}},{key:"getFolderId",value:function(){return this._folderId}},{key:"getFilter",value:function(){return this._filter||"all"}},{key:"setFilter",value:function(e){this._filter=e}},{key:"getIncomingCollabOnly",value:function(){return this._incomingCollabOnly||"none"}},{key:"setIncomingCollabOnly",value:function(e){this._incomingCollabOnly=e}},{key:"getSort",value:function(){return this._sort||"modified"}},{key:"setSort",value:function(e){this._sort=e}},{key:"getSortDirection",value:function(){return this._sortDirection||"desc"}},{key:"setSortDirection",value:function(e){this._sortDirection=e}},{key:"getBasePath",value:function(){return this._useFlatApi?"flat":"folders"}}]),e}();a.COMPONENT_NAME="spark-folder-discovery-spec",t.a=a},1331:function(e,t,r){"use strict";var o=r(46),n=r(61),i=r(292),a=r(268),s=r(293),l=r(3),c=r(26),d=r(13),u=r(301),h=r(1121),f=function(){function e(t,r){o(this,e),this._controller=r,this.id=t?t.id:null,this.assetId=t?t.assetId:null,this.parentFolder=t&&t.parentFolder instanceof h.a?t.parentFolder:null,this.name=t?t.name:"",this.type=t?t.type:null,this.contentModified=t?t.modified:null,this.thumbnail=t?t.thumbnail:"",this.eTag=t?t.eTag:"",this.isPublished=!!t&&!!t.isPublished,this._collaboration=t?t.collaboration:null,this._isBranded=!!t&&t.isBranded,this._ccpath=t?t.ccpath:"",this._sg=t?t._sg:null,this.metaFolder=t?t.metaFolder:null}return n(e,[{key:"isBranded",value:function(){return l.resolve(this._isBranded)}},{key:"isIncomingCollaboration",value:function(){return"INCOMING"===this.getCollaboration()}},{key:"isOutgoingCollaboration",value:function(){return"OUTGOING"===this.getCollaboration()}},{key:"getCollaborationForAnalytics",value:function(){var e=this.getCollaboration();return"INCOMING"===e?"collabRecipient":"OUTGOING"===e?"collabOwner":"collabNone"}},{key:"refreshInfo",value:function(e){var t=!1;return this.name===e.name&&this.contentModified===e.modified&&this.thumbnail===e.thumbnail&&this._isBranded===e.isBranded&&this._collaboration==e.collaboration||(t=!0),this.name=e.name,this.contentModified=e.modified,this.thumbnail=e.thumbnail,this._isBranded=e.isBranded,this._collaboration=e.collaboration,this.eTag=e.eTag,!this.parentFolder&&e.parentFolder&&e.parentFolder instanceof h.a&&(this.parentFolder=e.parentFolder),t}},{key:"getStorageURL",value:function(){return"https://"+window.marvel.settings.ss.replace("-creativesdk","")+"/id/"+this.assetId}},{key:"getStoragePath",value:function(){return this._ccpath}},{key:"getURN",value:function(){return l.resolve(this.assetId)}},{key:"getCompositeDoc",value:function(){var e=this,t=this.getMyApp().getSetting("syncGroup");return d.ensureSyncGroup(t).then((function(t){var r=t.getComposite(e.id);return r.then((function(t){t.setCollaboration(e.getCollaboration())})),r.then((function(t){return t.linkSparkAsset(e),t}))}))}},{key:"updateFromLinkedDoc",value:function(e){if(e){this.name=e.getProjectName();var t=e.getImageRendition(400);t&&(this.thumbnail=t.url)}}},{key:"getCollaboration",value:function(){return this._collaboration}},{key:"setCollaboration",value:function(e){this._collaboration!==e&&(this._collaboration=e)}},{key:"getMyApp",value:function(){var e=c.getAppByDocType(this.type);return e||"application/vnd.adobe.ginger.document+dcx"!==this.type||(e=c.getAppByDocType("application/vnd.adobe.ginger.project+dcx")),e}},{key:"getMyPrimaryApp",value:function(){return this.getMyApp()}},{key:"getProjectName",value:function(e){return this.name}},{key:"rename",value:function(e){var t=this;this.name=e,this.getCompositeDoc().then((function(r){t.getMyApp().setProjectName(r,e)}))}},{key:"move",value:function(e){return this._controller.move([this],e)}},{key:"duplicate",value:function(e,t){var r=this.getMyApp().getSetting("syncGroup");return this._duplicate(r,e,t)}},{key:"_duplicate",value:function(e,t,r,o){var n=this;return this.getCompositeDoc().then((function(i){var a=d.newCompositeAsCopyOf(i.get("compositeObj"),o);if(a){a.href=d.dcxSession.getHrefForComposite(a,e);var s=new u({name:t,id:a.id,modified:!1,syncGroupName:e,compositeObj:a});return d.addDocToSyncGroup(s,e),s.clearUnneededDuplicationData(),s.getMyApp().usesContentModifiedEtags()&&s.setContentModifiedIfNeeded(),s.getDCXRoot().setValue("name",t),d.pushComposite(a,e).then((function(){var e=s.getMyApp();return(e.postDuplicate?e.postDuplicate(s):l.resolve()).then((function(){return n._controller.createProject(s,r)}))}))}return l.reject(new Error("Failed to duplicate project"))}))}},{key:"getContentModifiedDate",value:function(){return this._unZpadDate(this.contentModified)}},{key:"_unZpadDate",value:function(e){var t=Date.parse(e),r=Number(t);if(r==r)return new Date(t);var o,n=e.split("T"),i=1*n[1].substring(0,2);if(i>23){var a=n[0]+"T23"+n[1].substring(2);return(o=new Date(a)).setUTCHours(o.getUTCHours()+(i-23)),o}return new Date}},{key:"belongsToUser",value:function(){return"INCOMING"!==this.getCollaboration()}}]),e}();f.COMPONENT_NAME="spark-asset";var g={voice:"video",theo:"post",slate:"page"},v=function(e){function t(){var e;o(this,t);for(var r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];return i(this,(e=a(t)).call.apply(e,[this].concat(n)))}return s(t,e),n(t,[{key:"get",value:function(e){return this[e]?this[e]:null}},{key:"getDisplayName",value:function(){var e=this.getMyApp();return e?e.getProjectName(this):""}},{key:"getItemTypeName",value:function(){var e=this.getMyApp(),t=e?e.getAppTypeID():null;return t?g[t]:"unknown"}},{key:"preflightDuplicateStockImages",value:function(){var e=this;return this.getCompositeDoc().then((function(t){return e.getMyPrimaryApp().batchCheckLicenses(t)}))}}]),t}(f);v.COMPONENT_NAME="spark-project";t.a=v},1473:function(e,t,r){"use strict";var o=r(46),n=r(61),i=r(1726),a=r(1728),s=function(){function e(t,r){o(this,e),this._controller=r,this._spec=t,this._sgLastTimestampMap={},this.folderName="",this.breadCrumbs=[],this.reset()}return n(e,[{key:"_makeItemHolder",value:function(){return{loaded:0,total:0,items:[]}}},{key:"reset",value:function(){this._etagBundle="",this._sgLastTimestampMap={},this.localProjects=this._makeItemHolder(),this.localFolders=this._makeItemHolder()}},{key:"_orderItems",value:function(e){var t=[],r=this._spec.getSort(),o=this._spec.getSortDirection();return"modified"===r?(t=e.sort((function(e,t){var r=e.getContentModifiedDate(),o=t.getContentModifiedDate();return r.getTime()<o.getTime()?-1:r.getTime()>o.getTime()?1:0})),"asc"!==o&&t.reverse()):t=a(e,[function(e){return i(e[r]).toLowerCase()},"id"],[o,"asc"]),t}},{key:"_sortItems",value:function(e){var t=this._spec.getSort(),r=this._spec.getSortDirection(),o=[];return o="modified"===t?e.sort((function(e,t){var r=e.getContentModifiedDate(),o=t.getContentModifiedDate();return r.getTime()<o.getTime()?-1:r.getTime()>o.getTime()?1:0})):e.sort((function(e,r){var o=e[t].toLowerCase(),n=r[t].toLowerCase();return o<n?-1:o>n?1:0})),"asc"!==r&&o.reverse(),o}},{key:"setSpec",value:function(e){this._spec&&e.getKey()===this._spec.getKey()||(this._spec=e,this.reset())}},{key:"getSpec",value:function(){return this._spec}},{key:"getPagingToken",value:function(){return this.projects.length>0?this.projects[this.projects.length-1].id:""}},{key:"getEtagBundle",value:function(){return this._etagBundle}},{key:"setEtagBundle",value:function(e){this._etagBundle=e}},{key:"getSgLastTimestampMap",value:function(){return this._sgLastTimestampMap}},{key:"setSgLastTimestampMap",value:function(e){this._sgLastTimestampMap=e||{}}},{key:"_findLocalItem",value:function(e,t){var r=-1;return e.items.forEach((function(e,o){e.id===t.id&&(r=o)})),r}},{key:"_addLocalItem",value:function(e,t){this._findLocalItem(e,t)<0&&(e.items[e.items.length]=t,e.loaded++,e.total++)}},{key:"_removeItemLocal",value:function(e,t){var r=this._findLocalItem(e,t);return r>-1&&(e.items.splice(r,1),e.loaded--,e.total--,!0)}},{key:"addProjectLocal",value:function(e,t){this._addLocalItem(this.localProjects,e),t&&this.sortProjects()}},{key:"addFolderLocal",value:function(e){this._addLocalItem(this.localFolders,e)}},{key:"removeFolderLocal",value:function(e){return this._removeItemLocal(this.localFolders,e)}},{key:"removeProjectLocal",value:function(e){return this._removeItemLocal(this.localProjects,e)}},{key:"sortProjects",value:function(){var e=this._orderItems(this.localProjects.items);this.localProjects.items=e}},{key:"loadMore",value:function(){return this._controller.loadMoreProjects(this)}},{key:"projects",get:function(){return this.localProjects.items}},{key:"folders",get:function(){return this.localFolders.items}},{key:"totalProjects",get:function(){return this.localProjects.total},set:function(e){this.localProjects.total=e}},{key:"totalFolders",get:function(){return this.localFolders.total},set:function(e){this.localFolders.total=e}}]),e}();s.COMPONENT_NAME="spark-folder-discovery-context",t.a=s},322:function(e,t,r){"use strict";r.r(t);var o=r(46),n=r(61),i=r(1295),a=r(3),s=r(6),l=r(5),c=r(111),d=r(1046),u=r(2831),h=(r(7),r(1473)),f=r(1292),g=r(1121),v=r(1331),y=new(function(){function e(){o(this,e),this._handlePreloaderReadyEvent=this._handlePreloaderReadyEvent.bind(this),this.reset(),window.marvel.events.on("document-collaboration-changed",this._handleProjectCollabChange.bind(this))}return n(e,[{key:"reset",value:function(){this._folderPromises={},this._foldersLocal={},this._projectsLocal={},this._currentSpecKey=""}},{key:"getOrganizerIndexingWorking",value:function(){return this._organizerIndexBackgroundWorking}},{key:"getOrganizerIndexingPromise",value:function(){return this._organizerIndexBackgroundPromise||a.resolve()}},{key:"addLocalProject",value:function(e){this._projectsLocal[e.id]=e}},{key:"getLocalProjectById",value:function(e){return this._projectsLocal[e]}},{key:"flushProjectWithId",value:function(e){var t=this._projectsLocal[e];Object.entries(this._foldersLocal).forEach((function(e){var r=d(e,2),o=(r[0],r[1]);o&&o.getDiscoveryContext().removeProjectLocal(t)})),delete this._projectsLocal[e]}},{key:"getLocalFolderById",value:function(e){return this._foldersLocal[e]}},{key:"flushFolderWithId",value:function(e){var t=this._foldersLocal[e];Object.entries(this._foldersLocal).forEach((function(e){var r=d(e,2),o=(r[0],r[1]);o&&o.getDiscoveryContext().removeFolderLocal(t)})),delete this._foldersLocal[e]}},{key:"folderFactory",value:function(e,t){var r;if(e.discoverySpec)r=e.discoverySpec.getFolderId();else{if(!e.id)throw new Error("Unkown folder model factory ",e);r=e.id}var o=this._foldersLocal[r];return o?e.discoverySpec&&o.setSpec(e.discoverySpec):(o=new g.a(e,this._controller),this._foldersLocal[o.id]=o),t&&(o.parentFolder=t),o}},{key:"loadFolder",value:function(e){var t=this,r=this.folderFactory({discoverySpec:e});if(!this._folderPromises[e.getKey()]){var o=r.getDiscoveryContext();this._folderPromises[e.getKey()]=this.loadMoreProjects(o).then((function(){if(r.name=o.folderName,"root"!==e.getFolderId()&&!r.parentFolder){if(!o.folderParentId)throw new Error("SparkStorageLoader requires parentFolderId to load folder");var n=t.folderFactory({name:o.folderParentName,discoverySpec:new f.a({filter:null,incomingCollabOnly:"none",sort:null,sortDirection:null,folderId:o.folderParentId})});r.parentFolder=n}return r}))}return this._folderPromises[e.getKey()]}},{key:"projectFactory",value:function(e){var t=new v.a(e,this._controller);return this._projectsLocal[e.id]=t,e.parentFolder&&e.parentFolder.getDiscoveryContext().addProjectLocal(t),t}},{key:"getLatestProjects",value:function(){var e=this;return this.authFetchJSON({uri:"/sp-storage/flat/root/all/all/modified/desc/"}).then((function(t){return t.folderProjects.slice(0,4).map((function(t){var r=e._projectsLocal[t.id];return r||(r=e.projectFactory(t)),r}))}))}},{key:"refreshOrganizer",value:function(e){var t=this;return c.load().then((function(r){return r.ACPSparkController.discoverFolder(e).then((function(o){return r.ActionController.execAction({title:"Refresh organizer",do:function(n){if(!r.ACPSparkController.isSpecCurrent(e.getKey()))return a.resolve();var i=o.getDiscoveryContext(),s=i.getEtagBundle(),c=Math.max(i.projectsDesired||i.projectsFetchedCount,i.projects.length),u=e.getBasePath();l.hasFeature("enable-odb")||(u="flat");var h="/sp-storage/"+u+"/"+e.getFolderId()+"/"+e.getFilter()+"/"+e.getIncomingCollabOnly()+"/"+e.getSort()+"/"+e.getSortDirection()+"?stopCount="+c+"&etagBundle="+s;return t.authFetchJSON({uri:h}).then((function(n){if(!r.ACPSparkController.isSpecCurrent(e.getKey()))return a.resolve();if(!t._organizerIndexBackgroundWorking&&(n.rebuildIndexRequired||n.moreIndexingRequired))return t._handleOdbIndexingBackground(n.rebuildIndexRequired,i).then((function(){return t.refreshOrganizer(e)}));if(n.noChanges)return a.resolve();i.setEtagBundle(n.etagBundle);var s={},l={added:[],updated:[],removed:[]};n.folderProjects.forEach((function(e){var r=t._projectsLocal[e.id];s[e.id]=!0,r?r.refreshInfo(e)&&l.updated.push(r):(e.parentFolder=o,r=t.projectFactory(e),l.added.push(r))})),Object.entries(t._projectsLocal).forEach((function(e){var r=d(e,2),n=r[0],i=r[1];i.parentFolder&&i.parentFolder.id===o.id&&(s[i.id]||(t.flushProjectWithId(n),l.removed.push(i)))})),i.totalProjects=n.totalProjects,l.removed.length&&i.setSgLastTimestampMap(n.sgLastTimestampMap),(l.added.length||l.removed.length||l.updated.length)&&(o.getDiscoveryContext().sortProjects(),window.marvel.events.trigger("odb-projects-changed",l),window.marvel.events.trigger("organizer-reload-datasource"));var c={added:[],removed:[],updated:[]},u={};return n.folders&&n.folders.forEach((function(e){u[e.id]=!0;var r=t._foldersLocal[e.id];r?r.refreshInfo(e)&&c.updated.push(r):(r=t.folderFactory(e,o),i.addFolderLocal(r),c.added.push(r))})),Object.entries(t._foldersLocal).forEach((function(e){var r=d(e,2),n=r[0],i=r[1];i&&!u[n]&&"root"!==n&&o.id===i.parentFolder.id&&(t.flushFolderWithId(n),c.removed.push(i))})),(c.added.length||c.removed.length||c.updated.length)&&(window.marvel.events.trigger("odb-folders-changed",c),window.marvel.events.trigger("organizer-reload-datasource")),a.resolve()}))}})}))}))}},{key:"loadMoreProjects",value:function(e,t,r,o){var n=this;if(this._organizerIndexBackgroundWorking)return window.marvel.logger.info("[Core:Folders] loadMoreProjects while indexing a large account"),this._organizerIndexBackgroundPromise;var i=e.getSpec(),a=i.getBasePath();l.hasFeature("enable-odb")||(a="flat");var s="";if(e instanceof h.a){var c=e.getSgLastTimestampMap();s=this._getTimestampQueryParams(c)}"flat"===a||u(t)||(s=this._getTimestampQueryParams(t)+"&processingMore=true");var d="/sp-storage/"+a+"/"+i.getFolderId()+"/"+i.getFilter()+"/"+i.getIncomingCollabOnly()+"/"+i.getSort()+"/"+i.getSortDirection()+"/"+e.getPagingToken()+s;return this.authFetchJSON({uri:d}).then((function(t){return n._initWithJSON(t,e,r||"loadMoreProjects",o)}))}},{key:"_getTimestampQueryParams",value:function(e){var t=e?Object.keys(e):[],r="";return t.forEach((function(t){r+="&".concat(t,"=").concat(e[t])})),r.replace("&","?")}},{key:"_rerequestPreloader",value:function(){return s.requiresAuth().then((function(){var e=document.createElement("script");e.type="text/javascript",e.src="/sp-storage/organizer?u="+String(Math.round(1e3*Math.random())),document.getElementsByTagName("head")[0].appendChild(e)})).catch((function(e){window.marvel.logger.error("[Client:Storage] unexpected error awaiting auth before reloading preloader",e)}))}},{key:"_initWithPreloader",value:function(){return this._initWithJSON(window._sgPreload||{},null,"preloader")}},{key:"_initWithJSON",value:function(e,t,r,o){var n,s=this,l=t,c=o||[];if((e.noChanges||void 0===e.folderProjects)&&!e.rebuildIndexRequired&&!e.moreIndexingRequired)return a.resolve();if(l)n=this.folderFactory({discoverySpec:l.getSpec()});else{var d=new f.a({folderId:e.folderId||"root",incomingCollabOnly:e.incomingCollabOnly||"none",filter:e.filter||"all",sort:e.sort||"modified",sortDirection:e.sortDirection||"desc",useFlatApi:!1===e.foldersEnabled||e.useFlat});n=this.folderFactory({discoverySpec:d}),l=n.getDiscoveryContext(),this._folderPromises[d.getKey()]=a.resolve(n)}if(!this._organizerIndexBackgroundWorking&&(e.rebuildIndexRequired||e.moreIndexingRequired))return window.marvel.logger.info("[Core:Folders] initiate indexing in the background"),this._handleOdbIndexingBackground(e.rebuildIndexRequired,l).then((function(){return s.loadMoreProjects(l)}));var u="".concat(e.folderId).concat(e.filter).concat(e.incomingCollabOnly).concat(e.sort).concat(e.sortDirection);if("preloader"!==r&&this._currentSpecKey!==u)return a.resolve();if(l.folderName=e.folderName,l.folderParentId=e.folderParentId,l.folderParentName=e.folderParentName,l.projectsFetchedCount=e.projectsFetchedCount,l.firstTimeODBUser=e.firstTimeODBUser,l.indexCompletion=e.indexCompletion,l.projectsInAnyFolderTotal=e.projectsInAnyFolderTotal,l.hasMore=e.hasMore,l.setEtagBundle(e.etagBundle),c=c.concat(e.folderProjects),"preloader"!==r&&e.needsMoreProcessing){var h=Object.assign({},e.sgLastTimestampMap,e.moreSgTimeStamp);return window.marvel.logger.info("[Core:Folders] storage result needs more processing, loading more projects",{moreSgTimeStamp:e.moreSgTimeStamp,mergedTimestamps:h,initContext:r,discoveryCtxt:t,projectsWorkingList:c}),this.loadMoreProjects(l,h,"moreProcessing",c)}c.forEach((function(e,t){var r;e.parentFolder=n,s._projectsLocal[e.id]&&(r=s._projectsLocal[e.id]).refreshInfo(e),r?l.addProjectLocal(r):r=s.projectFactory(e)}));var g={};i(this._projectsLocal,(function(e){g[e._sg]=e.contentModified})),l.totalProjects=e.totalProjects,l.setSgLastTimestampMap(g),this._controller.setAllProjectsCount(e.allProjectsCount);var v=e.folders||[];return v.forEach((function(e){var t=s.folderFactory(e,n);l.addFolderLocal(t)})),l.totalFolders=v.length,e.breadCrumbs instanceof Array&&(l.breadCrumbs=e.breadCrumbs),l.sortProjects(),a.resolve()}},{key:"_handleOdbIndexingBackground",value:function(e,t){var r=this;if(this._organizerIndexBackgroundWorking)return window.marvel.logger.warn("[Core:Folders] unexpected duplicate request to index in the background",{stack:(new Error).stack}),this._organizerIndexBackgroundPromise||a.resolve();this._organizerIndexBackgroundWorking=!0;var o="pageIndex";e&&(o="rebuildIndex");var n=c.load().then((function(e){return e.ACPSparkController.organizerIndexNext(o).then((function(e){return r._organizerIndexBackgroundWorking=!1,e.indexCompletion<1&&e.indexProcessedCount>0?(window.marvel.logger.info("[Core:Folders] handleOdbIndexingBackground continues "+e.indexCompletion,e),r._handleOdbIndexingBackground(e.rebuildIndexRequired,t)):(window.marvel.logger.info("[Core:Folders] handleOdbIndexingBackground indexing complete",e),r._organizerIndexBackgroundPromise=null,a.resolve())}))})).catch((function(e){r._organizerIndexBackgroundWorking=!1,r._organizerIndexBackgroundPromise=null,window.marvel.logger.error("[Core:Folders] handleOdbIndexingBackground failed.",e)}));return this._organizerIndexBackgroundPromise||(this._organizerIndexBackgroundPromise=n),n}},{key:"_detach",value:function(){this._attachDefer=null,window.marvel.events.off("sg-preload-ready",this._handlePreloaderReadyEvent)}},{key:"_handlePreloaderReadyEvent",value:function(){var e=this;window._sgPreloadUnauth&&!window._sgPreloaderUnauthRetry?(window._sgPreloaderUnauthRetry=!0,window._sgPreloadUnauth=!1,this._rerequestPreloader()):this._initWithPreloader().then((function(){e._attachDefer.resolve()}),(function(t){e._attachDefer.reject(t)}))}},{key:"_handleProjectCollabChange",value:function(e){var t=e.composite,r=e.collab,o=this._projectsLocal[t.id];if(o){var n=o.getCollaboration();0===r.collaborators.length?o.setCollaboration(void 0):n||o.setCollaboration("OUTGOING")}}},{key:"attach",value:function(e){var t=this;return this._controller=e,this._attachDefer||(this._attachDefer=a.defer(),window._sgPreloadUnauth&&(window._sgPreloadUnauth=!1,this._rerequestPreloader()),window._sgPreload?this._initWithPreloader().then((function(){t._attachDefer.resolve()}),(function(e){t._attachDefer.reject(e)})):window.marvel.events.on("sg-preload-ready",this._handlePreloaderReadyEvent)),this._attachDefer.promise}},{key:"setCurrentSpec",value:function(e){this._currentSpecKey=e.getKey()}},{key:"authFetchJSON",value:function(e){var t;return e.body instanceof String?t=e:(t=Object.assign({},e),t=Object.assign(t,{body:JSON.stringify(e.body)})),t.headers?t.headers["content-type"]||(t.headers["content-type"]="application/json"):t.headers={"content-type":"application/json"},this.authFetch(t).then((function(e){var t=a.defer();return e.json().then((function(e){t.resolve(e)})).catch((function(e){t.reject(e)})),t.promise}))}},{key:"authFetch",value:function(e){return s.requiresAuth().then((function(){return s.getAccessToken().then((function(t){var r=a.defer(),o=Object.assign({},e.headers);return o=Object.assign(o,{"x-access-token":t}),window.fetch(e.uri,{method:e.method||"GET",headers:new window.Headers(o),body:e.body}).then((function(e){if(200===e.status||204===e.status)r.resolve(e);else if(401===e.status)r.reject(new Error("Request auth failed; errorCode:"+e.status+"; errorText:"+e.statusText)),s.clearScope(),window.marvel.events.trigger("spark-auth-failed");else{var t=new Error("Request failed; errorCode:"+e.status+"; errorText:"+e.statusText);t.statusCode=e.status,r.reject(t)}}),(function(e){r.reject(e)})).catch((function(e){r.reject(e)})),r.promise}))}))}}]),e}()),p=new(function(){function e(){o(this,e),this._onSyncModeSet=this._onSyncModeSet.bind(this),this._onSyncTimer=this._onSyncTimer.bind(this),this._handleStorageSyncNow=this._handleStorageSyncNow.bind(this)}return n(e,[{key:"_handleSparkAssetUpdated",value:function(e){var t=this.getLocalProjectById(e.get("id"));if(t)t.name=e.get("name");else{var r=this.getCurrentFolder();this.createProject(e,r).then((function(e){}))}}},{key:"attach",value:function(){return this._isListening||(this._isListening=!0,window.marvel.events.on("set-sync-mode",this._onSyncModeSet),window.marvel.events.on("storage-sync-now",this._handleStorageSyncNow),this._handleSparkAssetUpdated=this._handleSparkAssetUpdated.bind(this),window.marvel.events.on("folder-document-updated",this._handleSparkAssetUpdated)),y.attach(this)}},{key:"_detach",value:function(){this._isListening&&(this._isListening=!1,this._syncInProgressKey=null,this._syncTimer=null,this._syncInProgress=null,this._currentFolderSpec=null,window.marvel.events.off("set-sync-mode",this._onSyncModeSet))}},{key:"isSpecCurrent",value:function(e){return e&&this._currentFolderSpec&&e===this._currentFolderSpec.getKey()}},{key:"_handleStorageSyncNow",value:function(){this._clearSyncTimer(),this._onSyncTimer()}},{key:"_onSyncTimer",value:function(e){var t=this,r=e||0;if(!this.isSpecCurrent(this._syncInProgressKey)){this._currentFolderSpec||(this._currentFolderSpec=new f.a);var o=this._currentFolderSpec.getKey();this._syncInProgressKey=o,this._syncInProgress=y.refreshOrganizer(this._currentFolderSpec).then((function(){t.isSpecCurrent(o)&&(t._syncInProgressKey=null,t._syncTimer=null,t._setSyncTimer())}),(function(e){t._syncInProgressKey=null;var o=0;r>1&&(o=500*Math.pow(2,r)),o>3e5?(window.marvel.logger.error("[Core:Folders] ACPSparkController abandoning refresh after "+r+" attempts, notifying user"),window.marvel.events.trigger("service-borked")):window.setTimeout((function(){t._onSyncTimer(r+1)}),o)})).done()}}},{key:"_setSyncTimer",value:function(){this._syncTimer||(this._syncTimer=window.setTimeout(this._onSyncTimer,12e4))}},{key:"_clearSyncTimer",value:function(){this._syncTimer&&(window.clearTimeout(this._syncTimer),this._syncTimer=null)}},{key:"isEditorOpen",value:function(){return"sync-editor"===this._syncMode}},{key:"_onSyncModeSet",value:function(e){e&&("sync-group"===e.mode&&"sync-group"!==this._syncMode&&(this._clearSyncTimer(),e.folderSpec&&(this._currentFolderSpec=e.folderSpec),this._onSyncTimer(),"sync-home"!==this._syncMode&&window.marvel.events.trigger("left-editing-session",{})),"sync-home"===e.mode?("sync-editor"===this._syncMode&&this._onSyncTimer(),this._clearSyncTimer(),e.previousFolderCallback&&e.previousFolderCallback(this._currentFolderSpec),e.folderSpec&&(this._currentFolderSpec=e.folderSpec)):"sync-group"===e.mode?(e.folderSpec&&(this._currentFolderSpec&&this._currentFolderSpec.getKey()===e.folderSpec.getKey()||this._clearSyncTimer(),this._currentFolderSpec=e.folderSpec),this._setSyncTimer()):"sync-editor"!==e.mode&&"sync-disabled"!==e.mode||this._clearSyncTimer(),this._syncMode=e.mode)}},{key:"_resetODB",value:function(){s.getAccessToken().then((function(e){window.fetch("/sp-storage/folders",{method:"DELETE",headers:new window.Headers({"x-access-token":e})}).then((function(e){marvel.navigate("/",{trigger:!0}),window.location.reload()})).catch((function(e){window.marvel.logger.warn("[Core:Folders] ACPSparkController failed to reset ODB",e)}))}))}},{key:"getCurrentFolder",value:function(){return this._currentFolderSpec?this.getLocalFolderById(this._currentFolderSpec.getFolderId()):null}},{key:"getLocalFolderById",value:function(e){return y.getLocalFolderById(e)}},{key:"getLocalProjectById",value:function(e){return y.getLocalProjectById(e)}},{key:"discoverFolder",value:function(e){return y.setCurrentSpec(e),y.attach(this).then((function(){return y.loadFolder(e)}))}},{key:"getLatestProjects",value:function(){return y.attach(this).then((function(){return y.getLatestProjects()}))}},{key:"loadMoreProjects",value:function(e){return y.loadMoreProjects(e)}},{key:"createFolder",value:function(e,t){return c.load().then((function(r){return r.ActionController.execAction({title:"Create Folder: "+e,do:function(r){return y.authFetchJSON({method:"POST",uri:"/sp-storage/folders",body:{parentFolderId:t.id,name:e}}).then((function(r){var o=t.getDiscoveryContext(),n=y.folderFactory({id:r.id,parentFolder:t,name:e},t);return o.addFolderLocal(n),window.marvel.events.trigger("odb-folders-changed",{added:[n]}),window.marvel.logger.info('[Core:Folders] Created new folder "'+e+'" in folder id: '+t.id),n}))},retry:function(r,o){return window.marvel.logger.warn('[Core:Folders] Retrying to create new folder "'+e+'" in folder id: '+t.id),r.retryConflicts(o,1)}})}))}},{key:"deleteSubfolder",value:function(e,t){return c.load().then((function(r){return r.ActionController.execAction({title:"Delete Folder",do:function(r){return y.flushFolderWithId(t),window.marvel.logger.info("[Core:Folders] Deleting folder id: "+t+" from folder id: "+e.id),y.authFetch({method:"DELETE",uri:"/sp-storage/folders/"+e.id+"/"+t})},retry:function(r,o){return window.marvel.logger.warn("[Core:Folders] Retrying to delete folder id: "+t+" from folder id: "+e.id),r.retryConflicts(o,1)}})}))}},{key:"renameFolder",value:function(e,t){var r=e.name;return e.setName(t),c.load().then((function(o){return o.ActionController.execAction({title:"Rename folder to "+t,do:function(o){return y.authFetchJSON({method:"POST",uri:"/sp-storage/patch-folder/"+e.id,body:{name:t}}).then((function(o){window.marvel.logger.info("[Core:Folders] Folder "+e.id+' renamed from "'+r+'" to "'+t+'"')})).catch((function(t){e.setName(r),window.marvel.logger.warn("[Core:Folders] ACPSparkController failed to rename folder",t)}))},retry:function(o,n){return window.marvel.logger.warn("[Core:Folders] Retrying to rename folder id: "+e.id+' from "'+r+'" to "'+t+'"'),o.retryConflicts(n,1)}})}))}},{key:"removeProjectFromParentFolder",value:function(e){var t=e.parentFolder,r=t.name||"ROOT",o=[];return e.id?(o.push(e.id),c.load().then((function(n){return n.ActionController.execAction({title:"Remove project "+e.name+" from "+r,do:function(n){return y.authFetchJSON({method:"POST",uri:"/sp-storage/patch-folder-remove/"+t.id,body:{projects:o}}).then((function(o){window.marvel.logger.info("[Core:Folders] Removed project "+e.name+" from "+r),t.getDiscoveryContext().removeProjectLocal(e)}))},retry:function(t,o){return window.marvel.logger.warn("[Core:Folders] Retrying to remove project "+e.name+" from "+r),t.retryConflicts(o,1)}})}))):(window.marvl.logger.warn("[Core:Folders] removeProjectFromParentFolder received invalid object."),a.reject())}},{key:"deleteProjectLocal",value:function(e){e.parentFolder.getDiscoveryContext().removeProjectLocal(e)}},{key:"createProject",value:function(e,t){var r=this,o=[e.getMyPrimaryApp().isBranded(e),e.getURN(),e.getImageRendition()];return a.allSettled(o).spread((function(o,n,i){var a=y.projectFactory({id:e.id,assetId:n.value,parentFolder:t,name:e.getProjectName(),type:e.getDCXComposite().type,modified:e.getContentModifiedDate().toISOString(),thumbnail:i.value||"",eTag:e.getContentModEtag(),isPublished:e.isPublished(),collaboration:e.getCollaboration(),isBranded:o.value,ccpath:e.getStoragePath()});return t&&"root"===t.id?(t.getDiscoveryContext().addProjectLocal(a,!0),a):t?r.move([a],t).then((function(){return a})):a}))}},{key:"_applyMovesToModel",value:function(e,t){i(e,(function(e){e instanceof g.a?(e.parentFolder&&e.parentFolder.getDiscoveryContext().removeFolderLocal(e),t.getDiscoveryContext().addFolderLocal(e)):(e.parentFolder&&e.parentFolder.getDiscoveryContext().removeProjectLocal(e),t.getDiscoveryContext().addProjectLocal(e,!0)),e.parentFolder=t}))}},{key:"move",value:function(e,t){var r=this;return c.load().then((function(o){return o.ActionController.execAction({title:"Move item(s)",do:function(o){var n=[];return e.forEach((function(e){var r={};e.parentFolder?r.oldFolderId=e.parentFolder.id:r.oldFolderId="root",r.newFolderId=t.id,e instanceof g.a?r.folderId=e.id:r.projectId=e.id,n.push(r)})),y.authFetchJSON({method:"POST",uri:"/sp-storage/patch-folders",body:{updates:n}}).then((function(){r._applyMovesToModel(e,t);var o=t.name||"Root";return window.marvel.logger.info("[Core:Folders] Moved "+e.length+" project(s) to "+o),t}))},retry:function(r,o){return!(o&&String(o).indexOf("errorCode:412")>=0)&&(window.marvel.logger.warn("[Core:Folders] Retrying to move "+e.length+' items to folder "'+t.name+'"'),r.retryConflicts(o,1))}})}))}},{key:"reset",value:function(){y.reset()}},{key:"organizerIndexNext",value:function(e){var t,r;switch(e){case"rebuildIndex":r=!0;break;case"pageIndex":t=!0;break;default:window.marvel.logger.error("[Core:Folders] Unsupported indexMode "+e)}return c.load().then((function(e){var o={usePageToken:t,forceRebuild:r};return y.authFetchJSON({method:"POST",uri:"/sp-storage/index",body:{params:o}}).then((function(e){return window.marvel.logger.info("[Core:Folders] ODB Index Next request completed",e),e}))}))}},{key:"listAuthoringContexts",value:function(e,t){return this.attach().then((function(){return y.getLocalAuthoringContextList(e).then((function(e){return e}))}))}},{key:"setAllProjectsCount",value:function(e){this._allProjectsCountDefer&&(this._allProjectsCountDefer.resolve(e),this._allProjectsCountDefer=null),this._allProjectsCount=e}},{key:"getAllProjectsCount",value:function(){return this._allProjectsCountDefer||void 0!==this._allProjectsCount?a.resolve(this._allProjectsCount):(this._allProjectsCountDefer=a.defer(),this._allProjectsCountDefer.promise)}},{key:"isOrganizerIndexing",value:function(){return y.getOrganizerIndexingWorking()}},{key:"getOrganizerIndexingPromise",value:function(){return y.getOrganizerIndexingPromise()}}]),e}()),m=function(){function e(t){o(this,e),this.title=t.title,this.fnDo=t.do,this.fnRetry=t.retry,this.defer=a.defer(),this._tried=0}return n(e,[{key:"do",value:function(){return this._tried++,this.fnDo(this)}},{key:"retry",value:function(e){return!!this.fnRetry&&this.fnRetry(this,e)}},{key:"retryDelay",value:function(){var e=this._tried-1;return e>0?500*Math.pow(e,2):0}},{key:"retryConflicts",value:function(e,t){return!!(e&&String(e).indexOf("errorCode:409")>=0&&this._tried<=t)}}]),e}();m.COMPONENT_NAME="spark-action";var _=m,k=function(){function e(){o(this,e),this._actionQueue=[],this._currentIndex=0,this._actionOutstanding=null}return n(e,[{key:"busy",value:function(){return!!this._actionOutstanding}},{key:"_nextAction",value:function(){this._actionOutstanding=null,this._currentIndex++,this._action()}},{key:"_handleOnlineError",value:function(e){var t=this;this._actionOutstanding.retry(e)?window.setTimeout((function(){window.marvel.logger.debug("retrying action "+t._actionOutstanding.title),t._actionOutstanding=null,t._action()}),this._actionOutstanding.retryDelay()):(this._actionOutstanding.defer.reject(e),this._nextAction())}},{key:"_action",value:function(){var e=this;!this._actionOutstanding&&this._actionQueue[this._currentIndex]&&(this._actionOutstanding=this._actionQueue[this._currentIndex],this._actionOutstanding.do().then((function(t){e._actionOutstanding.defer.resolve(t),e._nextAction()}),(function(t){s.checkIsOffline().then((function(r){r?window.marvel.logger.warn("suspending action processing due to being offline"):e._handleOnlineError(t)}))})).done())}},{key:"execAction",value:function(e){var t=new _(e);return this._actionQueue[this._actionQueue.length]=t,this._action(),t.defer.promise}}]),e}();k.COMPONENT_NAME="action-controller";var C=k;p.attach();t.default={ACPSparkController:p,ActionController:new C,SparkFolderDiscoverySpec:f.a}}}]);
//# sourceMappingURL=spark-core-wraper-07ef445a.js.map